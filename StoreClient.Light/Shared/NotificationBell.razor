@using StoreClient.Light.Services
@inject NotificationService NotifService
@implements IDisposable

<div class="notification-wrapper">
    <div class="bell-btn @(isOpen ? "active" : "")" @onclick="ToggleOpen">
        <i class="bi bi-bell-fill" style="font-size: 1.1rem;"></i>
        
        @if (NotifService.UnreadCount > 0)
        {
            <div class="badge-count">
                @(NotifService.UnreadCount > 9 ? "9+" : NotifService.UnreadCount)
            </div>
        }
    </div>

    @if (isOpen)
    {
        <div class="overlay" @onclick="Close"></div>

        <div class="notification-dropdown">
            <div class="dropdown-header">
                <span class="fw-bold small text-secondary">NOTIFICACIONES</span>
                @if (NotifService.UnreadCount > 0)
                {
                    <button class="mark-read-btn" @onclick="MarkAllRead">Marcar le√≠das</button>
                }
            </div>

            <div class="dropdown-body">
                @if (NotifService.Notifications.Count == 0)
                {
                    <div class="empty-state">
                        <i class="bi bi-bell-slash fs-3 mb-2 d-block opacity-50"></i>
                        <small>No tienes notificaciones</small>
                    </div>
                }
                else
                {
                    @foreach (var n in NotifService.Notifications)
                    {
                        <div class="notif-item @(!n.IsRead ? "unread" : "")">
                            <div class="notif-icon @(n.Type == "warning" ? "icon-warning" : "icon-info")">
                                <i class="bi @(n.Type == "warning" ? "bi-exclamation-triangle-fill" : "bi-info-circle-fill")"></i>
                            </div>
                            
                            <div class="notif-content">
                                <div class="notif-title">@n.Title</div>
                                <div class="notif-msg">@n.Message</div>
                                <span class="notif-time">@n.Timestamp.ToString("HH:mm")</span>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    }
</div>

@code {
    private bool isOpen = false;

    protected override void OnInitialized()
    {
        NotifService.OnChange += StateHasChanged;
    }

    private void ToggleOpen()
    {
        isOpen = !isOpen;
        if (isOpen) NotifService.MarkAllAsRead();
    }

    private void Close() => isOpen = false;

    private void MarkAllRead()
    {
        NotifService.MarkAllAsRead();
    }

    public void Dispose()
    {
        NotifService.OnChange -= StateHasChanged;
    }
}