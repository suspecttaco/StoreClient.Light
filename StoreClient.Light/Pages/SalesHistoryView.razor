@using System.Globalization

<div class="history-container animate__animated animate__fadeIn">
    
    <div class="filter-bar">
        <div class="d-flex align-items-center gap-2">
            <label class="small fw-bold text-muted">DESDE</label>
            <input type="date" class="date-input" @bind="startDate" />
        </div>
        
        <div class="d-flex align-items-center gap-2">
            <label class="small fw-bold text-muted">HASTA</label>
            <input type="date" class="date-input" @bind="endDate" />
        </div>

        <button class="btn btn-primary btn-sm px-3" @onclick="CargarVentas">
            <i class="bi bi-filter"></i> Filtrar
        </button>
    </div>

    <div class="split-layout">
        
        <div class="panel-table">
            <div class="panel-header">
                <span>Registro de Ventas</span>
                <span class="badge bg-light text-secondary border">@salesList.Count registros</span>
            </div>
            <div class="table-wrapper">
                @if (isLoading)
                {
                    <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
                }
                else if (salesList.Count == 0)
                {
                    <div class="text-center py-5 text-muted">No hay ventas en este periodo.</div>
                }
                else
                {
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Folio</th>
                                <th>Fecha</th>
                                <th>Cajero</th>
                                <th>Cliente</th>
                                <th>Método</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var sale in salesList)
                            {
                                <tr class="@(selectedSale?.Id == sale.Id ? "selected" : "")" 
                                    @onclick="() => SelectSale(sale)">
                                    
                                    <td class="font-monospace">#@sale.Id</td>
                                    <td>@sale.Date.ToString("dd/MM/yy HH:mm")</td>
                                    <td>@sale.UserName</td>
                                    <td>@(sale.CustomerName ?? "Público General")</td>
                                    <td><span class="badge bg-light text-dark border">@sale.PaymentMethod</span></td>
                                    <td class="text-end fw-bold">@sale.Total.ToString("C2", CultureInfo.CurrentCulture)</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>

        <div class="panel-table">
            <div class="panel-header">
                <span>Detalles de la Venta @(selectedSale != null ? $"#{selectedSale.Id}" : "")</span>
                
                @if (selectedSale != null)
                {
                    <div class="d-flex gap-2">
                        <button class="action-btn btn-print" @onclick="VerTicket">
                            <i class="bi bi-printer"></i> Imprimir
                        </button>
                        <button class="action-btn btn-cancel" @onclick="CancelarVenta">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </button>
                    </div>
                }
            </div>
            
            <div class="table-wrapper">
                @if (selectedSale == null)
                {
                    <div class="h-100 d-flex align-items-center justify-content-center text-muted opacity-50">
                        <i class="bi bi-hand-index-thumb me-2"></i> Selecciona una venta para ver detalles
                    </div>
                }
                else
                {
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th class="text-center">Cant.</th>
                                <th class="text-end">Precio U.</th>
                                <th class="text-end">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (selectedSale.Details != null)
                            {
                                foreach (var item in selectedSale.Details)
                                {
                                    <tr>
                                        <td>@item.ProductName</td>
                                        <td class="text-center">@item.Amount</td>
                                        <td class="text-end">@item.UnitPrice.ToString("C2")</td>
                                        <td class="text-end fw-bold">@item.Subtotal.ToString("C2")</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </div>
</div>

<ReceiptModal 
    IsVisible="@showTicketModal" 
    Title="@ticketTitle" 
    Content="@ticketContent" 
    OnClose="OnTicketClosed" />